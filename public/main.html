<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.1/p5.js"></script>
    <meta charset="utf-8" />
    <style>
      .subimage{
        width: 32px;
        height: 32px;
        background-size: 256px 192px;
        image-rendering: pixelated;
        cursor:pointer;
        margin:5px;
        display:inline-block;
      }
    </style>
  </head>
  <body style="background-color:black; display:flex;">
    <div>
      <button onclick="exportCode()">Export</button>
      <div id="tileList"></div>
      <div id="currTiles" style="width:calc((5 * 2px + 32px) * 8)"></div>
    </div>

    <script>
        class Entity{
          constructor(x,y,w,h){
            this.x=x;
            this.y=y;
            this.w=w;
            this.h=h;
          }
          render(){
            rect(this.x,this.y,this.w,this.h);
          }

          toCode(){ return ""; }
        }
        class GroundEntity extends Entity{
          constructor(x,y,w,h){
            super(x,y,w,h);
          }
          render(){
            fill(50,50,70);
            super.render();
          }

          toCode(){ return `SolidEntity(${this.x},${this.y},${this.w},${this.h},(50,50,70)).init(test_level)`; }
        }

        const entities=[];
        /*
        let currEntity;
        function mousePressed(){
          currEntity = new GroundEntity(mouseX, mouseY);
        }
        function mouseReleased(){
          if(currEntity.w<0){
            currEntity.x+=currEntity.w;
            currEntity.w*=-1;
          }
          if(currEntity.h<0){
            currEntity.y+=currEntity.h;
            currEntity.h*=-1;
          }
          entities.push(currEntity);
          currEntity=undefined;
        }
        */

        function exportCode(){
          console.log(entities.filter(e=>e.w!=0&&e.h!=0).map(e=>e.toCode()).join("\n"));
        }

        const paletteImages = {};
        let currPalette;
        let currTile;
        const paletteHolder = document.getElementById("tileList");
        const tileHolder = document.getElementById("currTiles");
        function getImgButton(src,x,y,onClick){
          const img = document.createElement("span");
          img.style["background-image"]=`url("/${src}.png")`;
          img.style["background-position"] = `${-x*4*8}px ${-y*4*8}px`;
          img.classList.add("subimage");
          img.addEventListener("click",onClick);
          return img;
        }
        function addPalette(name){
          paletteImages[name]=loadImage(`/${name}.png`);
          paletteHolder.appendChild(getImgButton(name, 0, 0, ()=>{
            currPalette=name;
            tileHolder.replaceChildren();
            for(let y=0;y<6;y++){
              for(let x=0;x<8;x++){
                tileHolder.appendChild(getImgButton(name, x, y, ()=>{
                  currTile=[x,y];
                }));
              }
            }
          }));
        }
        function preload() {
          addPalette("test");

          currPalette="test";
          currTile=[0,0];
        }

        function setup() {
          createCanvas(400, 400).elt.addEventListener("contextmenu",e=>e.preventDefault())
          noStroke();
          noSmooth();
        }

        const tiles=[];
        function placeTile(x,y){
          if(!tiles[y]) tiles[y]=[];
          tiles[y][x]={palette:currPalette,tile:currTile};
        }
        function removeTile(x,y){
          if(!tiles[y]) return;
          delete tiles[y][x];
        }

        function draw() {
          background(50);
          /*
          for(const entity of entities) entity.render();

          if(currEntity){
            currEntity.w=mouseX-currEntity.x;
            currEntity.h=mouseY-currEntity.y;
            currEntity.render();
          }
          */

          if(mouseIsPressed) (mouseButton=="right"?removeTile:placeTile)(Math.floor(mouseX/16),Math.floor(mouseY/16));
          for(let y=0;y<tiles.length;y++){
            if(!tiles[y]) continue;
            for(let x=0;x<tiles[y].length;x++)
              if(tiles[y][x]) image(paletteImages[tiles[y][x].palette], x*16,y*16, 16, 16,
                tiles[y][x].tile[0]*8, tiles[y][x].tile[1]*8, 8, 8);
          }
        }
    </script>
  </body>
</html>
